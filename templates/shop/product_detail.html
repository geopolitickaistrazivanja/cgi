{% extends 'base.html' %}
{% load static %}
{% load shop_filters %}

{% block title %}{{ product.title }} - EhoLux{% endblock %}

{% block content %}
<div class="product-detail-page">
    <div class="container">
        <div class="product-detail">
            <div class="product-images">
                {% if product_images %}
                    <div class="product-carousel">
                    {% if product_images|length > 1 %}
                        <button type="button" class="carousel-arrow carousel-prev" aria-label="Prethodna slika" id="carouselPrev">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 18l-6-6 6-6"/>
                            </svg>
                        </button>
                        {% endif %}
                        <div class="carousel-container">
                            <div class="carousel-track" id="carouselTrack">
                                {% for img in product_images %}
                                    <div class="carousel-slide {% if forloop.first %}active{% endif %}" data-index="{{ forloop.counter0 }}">
                                        <img src="{{ img.url }}" alt="{{ img.alt }}" class="carousel-image" data-index="{{ forloop.counter0 }}">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% if product_images|length > 1 %}
                            <button type="button" class="carousel-arrow carousel-next" aria-label="Sledeća slika" id="carouselNext">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 18l6-6-6-6"/>
                                </svg>
                            </button>
                        {% endif %}
                    </div>
                    {% if product_images|length > 1 %}
                        <div class="carousel-thumbnails">
                            {% for img in product_images %}
                                <img src="{{ img.url }}" alt="{{ img.alt }}" class="carousel-thumbnail {% if forloop.first %}active{% endif %}" data-index="{{ forloop.counter0 }}">
                            {% endfor %}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="product-placeholder">Nema slike</div>
                {% endif %}
            </div>
            
            <!-- Full Screen Lightbox -->
            <div class="lightbox" id="lightbox">
                <button type="button" class="lightbox-close" aria-label="Zatvori" id="lightboxClose">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
                <button type="button" class="lightbox-arrow lightbox-prev" aria-label="Prethodna slika" id="lightboxPrev">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </button>
                <div class="lightbox-container">
                    <img src="" alt="" id="lightboxImage" class="lightbox-image">
                </div>
                <button type="button" class="lightbox-arrow lightbox-next" aria-label="Sledeća slika" id="lightboxNext">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>
            </div>
            
            <div class="product-info">
                <h1>{{ product.title }}</h1>
                <p class="product-sku">SKU: {{ product.sku }}</p>

                <div class="product-description">
                    <div class="full-description">{{ product.full_description|safe }}</div>
                </div>

                {% if product.dimensions.exists %}
                    <div class="product-dimensions">
                        <h3>Dimenzije (Širina x Dubina x Visina)</h3>
                        <div class="dimension-select-wrapper">
                            <div class="dimension-select-custom" id="dimension-select-custom">
                                <div class="dimension-select-trigger" id="dimension-select-trigger">
                                    <span class="dimension-select-placeholder">-- Izaberite dimenzije --</span>
                                    <span class="dimension-select-arrow">▼</span>
                                </div>
                                <div class="dimension-select-options" id="dimension-select-options">
                                    <div class="dimension-select-option dimension-select-default" data-value="">
                                        <span class="dimension-option-text">-- Izaberite dimenzije --</span>
                                    </div>
                                    {% for dimension in product.dimensions.all %}
                                        <div class="dimension-select-option" data-value="{{ dimension.id }}" data-price="{% if dimension.price %}{{ dimension.price }}{% endif %}">
                                            <span class="dimension-option-text">{{ dimension.get_display }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="dimension-select" name="dimension_id" value="">
                        <input type="hidden" id="dimension-input" name="dimension_id" value="">
                    </div>
                {% endif %}

                {% if product.patterns.exists %}
                    <div class="product-patterns">
                        <h3>Dezeni</h3>
                        <div class="pattern-select-wrapper">
                            <div class="pattern-select-custom" id="pattern-select-custom">
                                <div class="pattern-select-trigger" id="pattern-select-trigger">
                                    <span class="pattern-select-placeholder">-- Izaberite dezen --</span>
                                    <span class="pattern-select-arrow">▼</span>
                                </div>
                                <div class="pattern-select-options" id="pattern-select-options">
                                    <div class="pattern-select-option pattern-select-default" data-value="" data-image="">
                                        <span class="pattern-option-text">-- Izaberite dezen --</span>
                                    </div>
                                    {% for pattern in product.patterns.all %}
                                        <div class="pattern-select-option" data-value="{{ pattern.id }}" data-image="{{ pattern.image.url }}">
                                            <img src="{{ pattern.image.url }}" alt="Dezen {{ forloop.counter }}" class="pattern-option-image">
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="pattern-select" name="pattern_id" value="">
                        <input type="hidden" id="pattern-input" name="pattern_id" value="">
                        <div class="pattern-selected-label" id="pattern-selected-label" style="display: none; margin-top: 10px;"><strong>Izabrani dezen:</strong></div>
                        <div class="pattern-preview" id="pattern-preview"></div>
                    </div>
                {% endif %}

                <div class="product-stock">
                    {% if product.is_in_stock %}
                        {% if product.stock_type == 'limited' %}
                            <p class="stock-info">Na stanju: {{ product.stock_quantity }} komada</p>
                        {% else %}
                            <p class="stock-info">Uvek na stanju</p>
                        {% endif %}
                    {% else %}
                        <p class="stock-info out-of-stock">Nema na stanju</p>
                    {% endif %}
                </div>

                {% if product.is_in_stock %}
                    <form class="add-to-cart-form" data-product-id="{{ product.id }}">
                        {% csrf_token %}
                        <div class="product-price" id="product-price-display" style="margin-bottom: 15px;">
                            <span class="current-price" id="current-price-text">Izaberite opcije</span>
                        </div>
                        <div class="quantity-selector">
                            <label for="quantity">Količina:</label>
                            <input type="number" id="quantity" name="quantity" value="1" min="1" {% if product.stock_type == 'limited' %}max="{{ product.stock_quantity }}"{% endif %}>
                        </div>
                        <input type="hidden" id="dimension-input" name="dimension_id" value="">
                        <input type="hidden" id="pattern-input" name="pattern_id" value="">
                        <button type="submit" class="btn btn-primary">Dodaj u korpu</button>
                    </form>
                {% endif %}
            </div>
        </div>

        {% if related_products %}
            <section class="related-products">
                <h2>Slični proizvodi</h2>
                    <div class="products-grid">
                    {% for product in related_products %}
                        <div class="product-card">
                            <a href="{% url 'shop:product_detail' product.slug %}">
                                {% if product.thumbnail %}
                                    <img src="{{ product.thumbnail.url }}" alt="{{ product.title }}">
                                {% elif product.images.first %}
                                    <img src="{{ product.images.first.image.url }}" alt="{{ product.title }}">
                                {% else %}
                                    <div class="product-placeholder">Nema slike</div>
                                {% endif %}
                                <h3>{{ product.title }}</h3>
                                <p class="product-price">Izaberite opcije</p>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </section>
        {% endif %}
    </div>
</div>

<script>
// ============================================
// NEW CAROUSEL IMPLEMENTATION - v2.0
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    // Product images data
    const productImages = [
        {% for img in product_images %}
        {
            url: '{{ img.url }}',
            alt: '{{ img.alt|escapejs }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    if (productImages.length === 0) {
        console.log('No product images found');
        return;
    }
    
    console.log('Carousel: Found', productImages.length, 'images');
    
    // Carousel variables
    let currentSlideIndex = 0;
    const slides = document.querySelectorAll('.carousel-slide');
    const thumbnails = document.querySelectorAll('.carousel-thumbnail');
    const prevBtn = document.getElementById('carouselPrev');
    const nextBtn = document.getElementById('carouselNext');
    
    console.log('Carousel: Found', slides.length, 'slides');
    console.log('Carousel: Found', thumbnails.length, 'thumbnails');
    console.log('Carousel: Prev button:', prevBtn ? 'Found' : 'NOT FOUND');
    console.log('Carousel: Next button:', nextBtn ? 'Found' : 'NOT FOUND');
    
    // Lightbox variables
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const lightboxCloseBtn = document.getElementById('lightboxClose');
    const lightboxPrevBtn = document.getElementById('lightboxPrev');
    const lightboxNextBtn = document.getElementById('lightboxNext');
    
    console.log('Lightbox:', lightbox ? 'Found' : 'NOT FOUND');
    
    // Show specific slide
    function showSlide(index) {
        if (index < 0) index = productImages.length - 1;
        if (index >= productImages.length) index = 0;
        
        currentSlideIndex = index;
        
        // Update slides
        slides.forEach((slide, i) => {
            slide.classList.toggle('active', i === index);
        });
        
        // Update thumbnails
        thumbnails.forEach((thumb, i) => {
            thumb.classList.toggle('active', i === index);
        });
    }
    
    // Next slide
    function nextSlide() {
        showSlide(currentSlideIndex + 1);
    }
    
    // Previous slide
    function prevSlide() {
        showSlide(currentSlideIndex - 1);
    }
    
    // Open lightbox
    function openLightbox(index) {
        if (index < 0 || index >= productImages.length) return;
        
        currentSlideIndex = index;
        lightboxImage.src = productImages[index].url;
        lightboxImage.alt = productImages[index].alt;
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Show/hide arrows
        if (productImages.length > 1) {
            if (lightboxPrevBtn) lightboxPrevBtn.style.display = 'flex';
            if (lightboxNextBtn) lightboxNextBtn.style.display = 'flex';
        } else {
            if (lightboxPrevBtn) lightboxPrevBtn.style.display = 'none';
            if (lightboxNextBtn) lightboxNextBtn.style.display = 'none';
        }
    }
    
    // Close lightbox
    function closeLightbox() {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
    }
    
    // Lightbox navigation functions
    function goToNextLightbox() {
        const nextIndex = (currentSlideIndex + 1) % productImages.length;
        openLightbox(nextIndex);
    }
    
    function goToPrevLightbox() {
        const prevIndex = (currentSlideIndex - 1 + productImages.length) % productImages.length;
        openLightbox(prevIndex);
    }
    
    // Event listeners - Carousel arrows
    if (prevBtn) {
        prevBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Prev button clicked');
            prevSlide();
        }, false);
    } else {
        console.error('Prev button not found!');
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Next button clicked');
            nextSlide();
        }, false);
    } else {
        console.error('Next button not found!');
    }
    
    // Event listeners - Thumbnails
    thumbnails.forEach(function(thumb, index) {
        thumb.style.cursor = 'pointer';
        thumb.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Thumbnail', index, 'clicked');
            showSlide(index);
        }, false);
    });
    
    // Event listeners - Image click to open lightbox
    slides.forEach(function(slide, index) {
        const img = slide.querySelector('.carousel-image');
        if (img) {
            img.style.cursor = 'pointer';
            img.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Image', index, 'clicked - opening lightbox');
                openLightbox(index);
            }, false);
        }
    });
    
    // Event listeners - Lightbox controls
    if (lightboxCloseBtn) {
        lightboxCloseBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Lightbox close clicked');
            closeLightbox();
        }, false);
    }
    
    if (lightboxPrevBtn) {
        lightboxPrevBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Lightbox prev clicked');
            goToPrevLightbox();
        }, false);
    }
    
    if (lightboxNextBtn) {
        lightboxNextBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Lightbox next clicked');
            goToNextLightbox();
        }, false);
    }
    
    // Close lightbox on background click
    if (lightbox) {
        lightbox.onclick = function(e) {
            if (e.target === lightbox) {
                closeLightbox();
            }
        };
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (lightbox && lightbox.classList.contains('active')) {
            if (e.key === 'Escape') {
                closeLightbox();
            } else if (e.key === 'ArrowLeft') {
                goToPrevLightbox();
            } else if (e.key === 'ArrowRight') {
                goToNextLightbox();
            }
        }
    });
    
    // Initialize first slide
    showSlide(0);
    console.log('Carousel initialized');
});

// ============================================
// PATTERN SELECTION (custom dropdown with images)
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    const patternSelectCustom = document.getElementById('pattern-select-custom');
    const patternSelectTrigger = document.getElementById('pattern-select-trigger');
    const patternSelectOptions = document.getElementById('pattern-select-options');
    const patternSelect = document.getElementById('pattern-select');
    const patternInput = document.getElementById('pattern-input');
    const patternPreview = document.getElementById('pattern-preview');
    const patternPlaceholder = patternSelectTrigger ? patternSelectTrigger.querySelector('.pattern-select-placeholder') : null;
    
    if (!patternSelectCustom || !patternSelectTrigger || !patternSelectOptions || !patternSelect || !patternInput) {
        return;
    }
    
    let selectedPatternImage = '';
    
    // Toggle dropdown
    patternSelectTrigger.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        patternSelectCustom.classList.toggle('open');
    });
    
    // Select option
    const patternOptions = patternSelectOptions.querySelectorAll('.pattern-select-option');
    const patternSelectedLabel = document.getElementById('pattern-selected-label');
    
    patternOptions.forEach(function(option) {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const value = this.dataset.value;
            const image = this.dataset.image;
            
            // Update hidden inputs
            patternSelect.value = value;
            patternInput.value = value;
            
            // Update placeholder
            if (patternPlaceholder) {
                if (value === '') {
                    patternPlaceholder.textContent = '-- Izaberite dezen --';
                } else {
                    patternPlaceholder.textContent = 'Izabran dezen';
                }
            }
            
            // Update preview and label visibility
            if (patternPreview) {
                if (value && image) {
                    patternPreview.innerHTML = '<img src="' + image + '" alt="Izabrani dezen" style="max-width: 200px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                    if (patternSelectedLabel) {
                        patternSelectedLabel.style.display = 'block';
                    }
                } else {
                    patternPreview.innerHTML = '';
                    if (patternSelectedLabel) {
                        patternSelectedLabel.style.display = 'none';
                    }
                }
            }
            
            // Store selected image
            selectedPatternImage = image;
            
            // Close dropdown
            patternSelectCustom.classList.remove('open');
        });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!patternSelectCustom.contains(e.target)) {
            patternSelectCustom.classList.remove('open');
        }
    });
});

// ============================================
// DIMENSION SELECTION (custom dropdown like pattern)
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    const dimensionSelectCustom = document.getElementById('dimension-select-custom');
    const dimensionSelectTrigger = document.getElementById('dimension-select-trigger');
    const dimensionSelectOptions = document.getElementById('dimension-select-options');
    const dimensionSelect = document.getElementById('dimension-select');
    const dimensionInput = document.getElementById('dimension-input');
    const dimensionPlaceholder = dimensionSelectTrigger ? dimensionSelectTrigger.querySelector('.dimension-select-placeholder') : null;
    
    if (!dimensionSelectCustom || !dimensionSelectTrigger || !dimensionSelectOptions || !dimensionSelect || !dimensionInput) {
        return;
    }
    
    // Toggle dropdown
    dimensionSelectTrigger.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dimensionSelectCustom.classList.toggle('open');
    });
    
    // Select option
    const dimensionOptions = dimensionSelectOptions.querySelectorAll('.dimension-select-option');
    const priceDisplay = document.getElementById('current-price-text');
    
    dimensionOptions.forEach(function(option) {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const value = this.dataset.value;
            const price = this.dataset.price;
            
            // Update hidden inputs
            dimensionSelect.value = value;
            dimensionInput.value = value;
            
            // Update placeholder
            if (dimensionPlaceholder) {
                if (value === '') {
                    dimensionPlaceholder.textContent = '-- Izaberite dimenzije --';
                } else {
                    const selectedText = this.querySelector('.dimension-option-text').textContent;
                    dimensionPlaceholder.textContent = selectedText;
                }
            }
            
            // Update price display with thousands separator
            if (priceDisplay) {
                if (value === '') {
                    priceDisplay.textContent = 'Izaberite opcije';
                } else if (price && price !== '') {
                    // Format price with thousands separator, no decimals
                    const priceNum = parseInt(parseFloat(price));
                    priceDisplay.textContent = priceNum.toLocaleString('sr-RS') + ' RSD';
                } else {
                    priceDisplay.textContent = 'Izaberite opcije';
                }
            }
            
            // Close dropdown
            dimensionSelectCustom.classList.remove('open');
        });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!dimensionSelectCustom.contains(e.target)) {
            dimensionSelectCustom.classList.remove('open');
        }
    });
});

// ============================================
// ADD TO CART FORM
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    const addToCartForm = document.querySelector('.add-to-cart-form');
    if (!addToCartForm) {
        console.log('Add to cart form not found');
        return;
    }
    
    const dimensionSelect = document.getElementById('dimension-select');
    const patternSelect = document.getElementById('pattern-select');
    const dimensionInput = document.getElementById('dimension-input');
    const patternInput = document.getElementById('pattern-input');
    
    addToCartForm.onsubmit = function(e) {
        e.preventDefault();
        
        const productId = this.dataset.productId;
        const quantity = document.getElementById('quantity').value;
        
        // Update hidden inputs from selects before validation
        if (dimensionSelect && dimensionInput) {
            dimensionInput.value = dimensionSelect.value || '';
        }
        if (patternSelect && patternInput) {
            patternInput.value = patternSelect.value || '';
        }
        
        // Get values directly from hidden inputs (most reliable)
        const dimensionId = dimensionInput ? (dimensionInput.value || '') : '';
        const patternId = patternInput ? (patternInput.value || '') : '';
        
        // Validate and show visual feedback instead of alerts
        let hasError = false;
        let errorElements = [];
        
        // Get selected dimension to check if it has a price
        const dimensionSelectOptions = document.getElementById('dimension-select-options');
        let selectedDimensionHasPrice = false;
        
        if (dimensionId) {
            const selectedOption = dimensionSelectOptions ? dimensionSelectOptions.querySelector(`[data-value="${dimensionId}"]`) : null;
            if (selectedOption) {
                const dimensionPrice = selectedOption.dataset.price;
                selectedDimensionHasPrice = dimensionPrice && dimensionPrice !== '';
            }
        }
        
        // Check dimension field
        if (dimensionInput && dimensionInput.value === '') {
            hasError = true;
            const dimensionErrorElement = document.getElementById('dimension-select-custom') ? document.getElementById('dimension-select-custom').closest('.product-dimensions') : null;
            if (dimensionErrorElement) {
                errorElements.push(dimensionErrorElement);
            }
        } else if (dimensionInput && dimensionInput.value !== '' && !selectedDimensionHasPrice) {
            hasError = true;
            const dimensionErrorElement = document.getElementById('dimension-select-custom') ? document.getElementById('dimension-select-custom').closest('.product-dimensions') : null;
            if (dimensionErrorElement) {
                errorElements.push(dimensionErrorElement);
            }
        }
        
        // Check pattern field (mandatory)
        if (patternInput && patternInput.value === '') {
            hasError = true;
            const patternErrorElement = document.getElementById('pattern-select-custom') ? document.getElementById('pattern-select-custom').closest('.product-patterns') : null;
            if (patternErrorElement) {
                errorElements.push(patternErrorElement);
            }
        }
        
        if (hasError && errorElements.length > 0) {
            // Scroll to first error element
            errorElements[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Remove any existing error highlights
            document.querySelectorAll('.field-error-highlight').forEach(function(el) {
                el.classList.remove('field-error-highlight');
                const highlightRect = el.querySelector('.error-highlight-rect');
                if (highlightRect) {
                    highlightRect.remove();
                }
            });
            
            // Add red rectangles around dropdown triggers
            errorElements.forEach(function(errorElement) {
                const dimensionTrigger = errorElement.querySelector('.dimension-select-trigger');
                const patternTrigger = errorElement.querySelector('.pattern-select-trigger');
                
                if (dimensionTrigger) {
                    addErrorHighlight(dimensionTrigger);
                }
                if (patternTrigger) {
                    addErrorHighlight(patternTrigger);
                }
            });
            
            // Remove highlights after 3 seconds
            setTimeout(function() {
                document.querySelectorAll('.field-error-highlight').forEach(function(el) {
                    el.classList.remove('field-error-highlight');
                    const highlightRect = el.querySelector('.error-highlight-rect');
                    if (highlightRect) {
                        highlightRect.remove();
                    }
                });
            }, 3000);
            
            return false;
        }
        
        // Prepare form data
        const formData = new FormData();
        formData.append('quantity', quantity);
        formData.append('dimension_id', dimensionId);
        formData.append('pattern_id', patternId);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Send request
        fetch('/prodavnica/dodaj-u-korpu/' + productId + '/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                // Update cart count for both desktop and mobile
                const cartCountElements = document.querySelectorAll('.cart-count');
                if (data.cart_count > 0) {
                    if (cartCountElements.length > 0) {
                        // Update all existing cart count elements
                        cartCountElements.forEach(function(el) {
                            el.textContent = data.cart_count;
                            el.style.display = 'flex';
                        });
                    } else {
                        // Create cart count for desktop if it doesn't exist
                        const cartIconDesktop = document.querySelector('#cartIconBtn');
                        if (cartIconDesktop && !cartIconDesktop.querySelector('.cart-count')) {
                            const countSpan = document.createElement('span');
                            countSpan.className = 'cart-count';
                            countSpan.textContent = data.cart_count;
                            cartIconDesktop.appendChild(countSpan);
                        }
                        // Create cart count for mobile if it doesn't exist
                        const cartIconMobile = document.querySelector('#cartIconBtnMobile');
                        if (cartIconMobile && !cartIconMobile.querySelector('.cart-count')) {
                            const countSpan = document.createElement('span');
                            countSpan.className = 'cart-count';
                            countSpan.textContent = data.cart_count;
                            cartIconMobile.appendChild(countSpan);
                        }
                    }
                } else {
                    // Remove all cart count elements if cart is empty
                    cartCountElements.forEach(function(el) {
                        el.remove();
                    });
                }
                
                // Show notification
                showCartNotification(data.message);
            } else {
                showCartNotification(data.message, 'error');
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            showCartNotification('Došlo je do greške. Molimo pokušajte ponovo.', 'error');
        });
        
        return false;
    };
    
    // Add red rectangle highlight around element
    function addErrorHighlight(targetElement) {
        targetElement.classList.add('field-error-highlight');
        
        // Create fixed positioned rectangle that follows the element
        const highlightRect = document.createElement('div');
        highlightRect.className = 'error-highlight-rect';
        highlightRect.style.position = 'fixed';
        highlightRect.style.pointerEvents = 'none';
        highlightRect.style.zIndex = '10000';
        highlightRect.style.border = '3px solid #dc3545';
        highlightRect.style.borderRadius = '5px';
        highlightRect.style.boxSizing = 'border-box';
        highlightRect.style.animation = 'fieldErrorBlink 0.6s ease-in-out 5';
        document.body.appendChild(highlightRect);
        
        // Function to update rectangle position (using viewport coordinates for fixed positioning)
        function updatePosition() {
            const rect = targetElement.getBoundingClientRect();
            highlightRect.style.top = rect.top + 'px';
            highlightRect.style.left = rect.left + 'px';
            highlightRect.style.width = rect.width + 'px';
            highlightRect.style.height = rect.height + 'px';
        }
        
        // Initial position
        updatePosition();
        
        // Update position on scroll, resize, and zoom
        const updateEvents = ['scroll', 'resize', 'orientationchange'];
        const updateHandler = function() {
            updatePosition();
        };
        
        updateEvents.forEach(function(eventType) {
            window.addEventListener(eventType, updateHandler, { passive: true });
        });
        
        // Also update on touchmove for mobile zoom/pan
        document.addEventListener('touchmove', updateHandler, { passive: true });
        
        // Store handler reference for cleanup
        highlightRect._updateHandler = updateHandler;
        highlightRect._updateEvents = updateEvents;
        
        // Cleanup function
        highlightRect._cleanup = function() {
            updateEvents.forEach(function(eventType) {
                window.removeEventListener(eventType, updateHandler);
            });
            document.removeEventListener('touchmove', updateHandler);
            if (highlightRect.parentNode) {
                highlightRect.parentNode.removeChild(highlightRect);
            }
        };
        
        // Auto cleanup after 3 seconds
        setTimeout(function() {
            if (highlightRect._cleanup) {
                highlightRect._cleanup();
            }
            targetElement.classList.remove('field-error-highlight');
        }, 3000);
    }
    
    // Notification function
    function showCartNotification(message, type) {
        type = type || 'success';
        
        // Remove existing
        const existing = document.querySelector('.cart-notification');
        if (existing) {
            existing.remove();
        }
        
        // Create new
        const notification = document.createElement('div');
        notification.className = 'cart-notification cart-notification-' + type;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Show
        setTimeout(function() {
            notification.classList.add('show');
        }, 10);
        
        // Hide after 3 seconds
        setTimeout(function() {
            notification.classList.remove('show');
            setTimeout(function() {
                notification.remove();
            }, 300);
        }, 3000);
    }
    
    console.log('Add to cart form initialized');
});
</script>
{% endblock %}

