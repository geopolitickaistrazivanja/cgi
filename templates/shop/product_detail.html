{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.title }} - EhoLux{% endblock %}

{% block content %}
<div class="product-detail-page">
    <div class="container">
        <div class="product-detail">
            <div class="product-images">
                {% if product_images %}
                    <div class="product-carousel">
                    {% if product_images|length > 1 %}
                        <button class="carousel-arrow carousel-prev" aria-label="Prethodna slika" id="carouselPrev">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 18l-6-6 6-6"/>
                            </svg>
                        </button>
                        {% endif %}
                        <div class="carousel-container">
                            <div class="carousel-track" id="carouselTrack">
                                {% for img in product_images %}
                                    <div class="carousel-slide {% if forloop.first %}active{% endif %}" data-index="{{ forloop.counter0 }}">
                                        <img src="{{ img.url }}" alt="{{ img.alt }}" class="carousel-image" data-index="{{ forloop.counter0 }}">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% if product_images|length > 1 %}
                            <button class="carousel-arrow carousel-next" aria-label="Sledeća slika" id="carouselNext">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 18l6-6-6-6"/>
                                </svg>
                            </button>
                        {% endif %}
                    </div>
                    {% if product_images|length > 1 %}
                        <div class="carousel-thumbnails">
                            {% for img in product_images %}
                                <img src="{{ img.url }}" alt="{{ img.alt }}" class="carousel-thumbnail {% if forloop.first %}active{% endif %}" data-index="{{ forloop.counter0 }}" onclick="selectThumbnail({{ forloop.counter0 }})">
                            {% endfor %}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="product-placeholder">Nema slike</div>
                {% endif %}
            </div>
            
            <!-- Full Screen Lightbox -->
            <div class="lightbox" id="lightbox">
                <button class="lightbox-close" aria-label="Zatvori" id="lightboxClose">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
                <button class="lightbox-arrow lightbox-prev" aria-label="Prethodna slika" id="lightboxPrev">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </button>
                <div class="lightbox-container">
                    <img src="" alt="" id="lightboxImage" class="lightbox-image">
                </div>
                <button class="lightbox-arrow lightbox-next" aria-label="Sledeća slika" id="lightboxNext">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>
            </div>
            
            <div class="product-info">
                <h1>{{ product.title }}</h1>
                <p class="product-sku">SKU: {{ product.sku }}</p>
                
                <div class="product-price">
                    {% if product.price %}
                        <span class="current-price">{{ product.price }} RSD</span>
                    {% else %}
                        <span class="current-price">Na upit</span>
                    {% endif %}
                </div>

                <div class="product-description">
                    <div class="full-description">{{ product.full_description|safe }}</div>
                </div>

                {% if product.dimensions.exists %}
                    <div class="product-dimensions">
                        <h3>Dimenzije (Širina x Dubina x Visina)</h3>
                        <label for="dimension-select">Izaberite dimenzije:</label>
                        <select id="dimension-select" name="dimension_id" required>
                            <option value="">-- Izaberite dimenzije --</option>
                            {% for dimension in product.dimensions.all %}
                                <option value="{{ dimension.id }}">{{ dimension.get_display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}

                {% if product.patterns.exists %}
                    <div class="product-patterns">
                        <h3>Dezeni</h3>
                        <label for="pattern-select">Izaberite dezen:</label>
                        <div class="pattern-select-wrapper">
                            <select id="pattern-select" name="pattern_id" required style="display: none;">
                                <option value="">-- Izaberite dezen --</option>
                                {% for pattern in product.patterns.all %}
                                    <option value="{{ pattern.id }}" data-image="{{ pattern.image.url }}">{{ forloop.counter }}</option>
                                {% endfor %}
                            </select>
                            <div class="pattern-select-custom" id="pattern-select-custom">
                                <div class="pattern-select-trigger">
                                    <span class="pattern-select-placeholder">-- Izaberite dezen --</span>
                                    <span class="pattern-select-arrow">▼</span>
                                </div>
                                <div class="pattern-select-options" id="pattern-select-options">
                                    {% for pattern in product.patterns.all %}
                                        <div class="pattern-select-option" data-value="{{ pattern.id }}" data-image="{{ pattern.image.url }}">
                                            <img src="{{ pattern.image.url }}" alt="Dezen {{ forloop.counter }}" class="pattern-option-image">
                                            <span class="pattern-option-label">Dezen {{ forloop.counter }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="pattern-input" name="pattern_id" value="">
                        <div style="margin-top: 10px;"><strong>Izabrani dezen:</strong></div>
                        <div class="pattern-preview" id="pattern-preview"></div>
                    </div>
                {% endif %}

                <div class="product-stock">
                    {% if product.is_in_stock %}
                        {% if product.stock_type == 'limited' %}
                            <p class="stock-info">Na stanju: {{ product.stock_quantity }} komada</p>
                        {% else %}
                            <p class="stock-info">Uvek na stanju</p>
                        {% endif %}
                    {% else %}
                        <p class="stock-info out-of-stock">Nema na stanju</p>
                    {% endif %}
                </div>

                {% if product.is_in_stock %}
                    <form class="add-to-cart-form" data-product-id="{{ product.id }}">
                        {% csrf_token %}
                        <div class="quantity-selector">
                            <label for="quantity">Količina:</label>
                            <input type="number" id="quantity" name="quantity" value="1" min="1" {% if product.stock_type == 'limited' %}max="{{ product.stock_quantity }}"{% endif %}>
                        </div>
                        <input type="hidden" id="dimension-input" name="dimension_id" value="">
                        <input type="hidden" id="pattern-input" name="pattern_id" value="">
                        <button type="submit" class="btn btn-primary">Dodaj u korpu</button>
                    </form>
                {% endif %}
            </div>
        </div>

        {% if related_products %}
            <section class="related-products">
                <h2>Slični proizvodi</h2>
                    <div class="products-grid">
                    {% for product in related_products %}
                        <div class="product-card">
                            <a href="{% url 'shop:product_detail' product.slug %}">
                                {% if product.thumbnail %}
                                    <img src="{{ product.thumbnail.url }}" alt="{{ product.title }}">
                                {% elif product.images.first %}
                                    <img src="{{ product.images.first.image.url }}" alt="{{ product.title }}">
                                {% else %}
                                    <div class="product-placeholder">Nema slike</div>
                                {% endif %}
                                <h3>{{ product.title }}</h3>
                                <p class="product-price">
                                    {% if product.price %}
                                        {{ product.price }} RSD
                                    {% else %}
                                        Na upit
                                    {% endif %}
                                </p>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </section>
        {% endif %}
    </div>
</div>

<script>
// Product images data for carousel
const productImages = [
    {% for img in product_images %}
    {
        url: '{{ img.url }}',
        alt: '{{ img.alt|escapejs }}'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Product Carousel and Lightbox functionality
function initProductCarousel() {
    let currentIndex = 0;
    const slides = document.querySelectorAll('.carousel-slide');
    const prevBtn = document.getElementById('carouselPrev');
    const nextBtn = document.getElementById('carouselNext');
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const lightboxClose = document.getElementById('lightboxClose');
    const lightboxPrev = document.getElementById('lightboxPrev');
    const lightboxNext = document.getElementById('lightboxNext');
    
    // Show slide at index
    function showSlide(index) {
        // Remove active class from all slides and thumbnails
        slides.forEach(slide => slide.classList.remove('active'));
        const thumbnails = document.querySelectorAll('.carousel-thumbnail');
        thumbnails.forEach(thumbnail => thumbnail.classList.remove('active'));
        
        // Add active class to current slide and thumbnail
        if (slides[index]) {
            slides[index].classList.add('active');
        }
        if (thumbnails[index]) {
            thumbnails[index].classList.add('active');
        }
        
        currentIndex = index;
    }
    
    // Select thumbnail function (called from onclick)
    window.selectThumbnail = function(index) {
        showSlide(index);
    };
    
    // Next slide
    function nextSlide() {
        const nextIndex = (currentIndex + 1) % productImages.length;
        showSlide(nextIndex);
    }
    
    // Previous slide
    function prevSlide() {
        const prevIndex = (currentIndex - 1 + productImages.length) % productImages.length;
        showSlide(prevIndex);
    }
    
    // Open lightbox
    function openLightbox(index) {
        if (productImages[index]) {
            lightboxImage.src = productImages[index].url;
            lightboxImage.alt = productImages[index].alt;
            currentIndex = index;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Show/hide arrows based on number of images
            if (productImages.length > 1) {
                if (lightboxPrev) lightboxPrev.style.display = 'flex';
                if (lightboxNext) lightboxNext.style.display = 'flex';
            } else {
                if (lightboxPrev) lightboxPrev.style.display = 'none';
                if (lightboxNext) lightboxNext.style.display = 'none';
            }
        }
    }
    
    // Close lightbox
    function closeLightbox() {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
    }
    
    // Lightbox navigation
    function lightboxNextFunc() {
        const nextIndex = (currentIndex + 1) % productImages.length;
        openLightbox(nextIndex);
    }
    
    function lightboxPrevFunc() {
        const prevIndex = (currentIndex - 1 + productImages.length) % productImages.length;
        openLightbox(prevIndex);
    }
    
    // Event listeners for carousel arrows
    if (prevBtn) {
        prevBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            prevSlide();
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            nextSlide();
        });
    }
    
    
    // Event listeners for image click (open lightbox)
    slides.forEach((slide, index) => {
        const img = slide.querySelector('.carousel-image');
        if (img) {
            img.addEventListener('click', () => {
                openLightbox(index);
            });
        }
    });
    
    // Lightbox controls
    if (lightboxClose) {
        lightboxClose.addEventListener('click', closeLightbox);
    }
    
    if (lightboxPrev) {
        lightboxPrev.addEventListener('click', (e) => {
            e.stopPropagation();
            lightboxPrevFunc();
        });
    }
    
    if (lightboxNext) {
        lightboxNext.addEventListener('click', (e) => {
            e.stopPropagation();
            lightboxNextFunc();
        });
    }
    
    // Close lightbox on background click
    if (lightbox) {
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                closeLightbox();
            }
        });
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (lightbox.classList.contains('active')) {
            if (e.key === 'Escape') {
                closeLightbox();
            } else if (e.key === 'ArrowLeft') {
                lightboxPrevFunc();
            } else if (e.key === 'ArrowRight') {
                lightboxNextFunc();
            }
        }
    });
    
    // Touch/swipe support for mobile
    let touchStartX = 0;
    let touchEndX = 0;
    
    const carouselContainer = document.querySelector('.carousel-container');
    if (carouselContainer) {
        carouselContainer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        carouselContainer.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });
    }
    
    const lightboxContainer = document.querySelector('.lightbox-container');
    if (lightboxContainer) {
        lightboxContainer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        lightboxContainer.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            if (lightbox.classList.contains('active')) {
                handleSwipe();
            }
        });
    }
    
    function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;
        
        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                // Swipe left - next
                if (lightbox.classList.contains('active')) {
                    lightboxNextFunc();
                } else {
                    nextSlide();
                }
            } else {
                // Swipe right - previous
                if (lightbox.classList.contains('active')) {
                    lightboxPrevFunc();
                } else {
                    prevSlide();
                }
            }
        }
    }
}

// Initialize carousel when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    if (productImages.length > 0) {
        initProductCarousel();
    }
    
    // Handle dimension and pattern selection
    const dimensionSelect = document.getElementById('dimension-select');
    const patternSelect = document.getElementById('pattern-select');
    const dimensionInput = document.getElementById('dimension-input');
    const patternInput = document.getElementById('pattern-input');
    const patternPreview = document.getElementById('pattern-preview');
    const addToCartForm = document.querySelector('.add-to-cart-form');
    
    if (dimensionSelect && dimensionInput) {
        dimensionSelect.addEventListener('change', function() {
            dimensionInput.value = this.value;
        });
        // Set initial value
        dimensionInput.value = dimensionSelect.value;
    }
    
    // Custom pattern select with images
    const patternSelectCustom = document.getElementById('pattern-select-custom');
    const patternSelectOptions = document.getElementById('pattern-select-options');
    const patternSelectTrigger = patternSelectCustom ? patternSelectCustom.querySelector('.pattern-select-trigger') : null;
    const patternSelectPlaceholder = patternSelectCustom ? patternSelectCustom.querySelector('.pattern-select-placeholder') : null;
    
    if (patternSelectCustom && patternSelect && patternInput) {
        let isOpen = false;
        
        // Toggle dropdown
        if (patternSelectTrigger) {
            patternSelectTrigger.addEventListener('click', function(e) {
                e.stopPropagation();
                isOpen = !isOpen;
                patternSelectCustom.classList.toggle('open', isOpen);
            });
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (patternSelectCustom && !patternSelectCustom.contains(e.target)) {
                isOpen = false;
                patternSelectCustom.classList.remove('open');
            }
        });
        
        // Handle option selection
        if (patternSelectOptions) {
            patternSelectOptions.querySelectorAll('.pattern-select-option').forEach(function(option) {
                option.addEventListener('click', function() {
                    const value = this.dataset.value;
                    const image = this.dataset.image;
                    const label = this.querySelector('.pattern-option-label').textContent;
                    
                    // Update hidden select and input
                    patternSelect.value = value;
                    patternInput.value = value;
                    
                    // Update trigger display
                    if (patternSelectPlaceholder) {
                        const selectedImage = this.querySelector('.pattern-option-image').cloneNode(true);
                        selectedImage.style.width = '30px';
                        selectedImage.style.height = '30px';
                        selectedImage.style.marginRight = '8px';
                        selectedImage.style.objectFit = 'cover';
                        patternSelectPlaceholder.innerHTML = '';
                        patternSelectPlaceholder.appendChild(selectedImage);
                        patternSelectPlaceholder.appendChild(document.createTextNode(label));
                    }
                    
                    // Show preview
                    if (patternPreview) {
                        patternPreview.innerHTML = `<img src="${image}" alt="${label}" style="max-width: 200px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;">`;
                    }
                    
                    // Close dropdown
                    isOpen = false;
                    patternSelectCustom.classList.remove('open');
                    
                    // Trigger change event on select
                    patternSelect.dispatchEvent(new Event('change'));
                });
            });
        }
        
        // Also handle direct select changes (for form submission)
        patternSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            patternInput.value = this.value;
            
            if (this.value && selectedOption.dataset.image) {
                if (patternPreview) {
                    patternPreview.innerHTML = `<img src="${selectedOption.dataset.image}" alt="${selectedOption.text}" style="max-width: 200px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;">`;
                }
            } else {
                if (patternPreview) {
                    patternPreview.innerHTML = '';
                }
            }
        });
    }
    
    // Update form submission to include dimension and pattern
    if (addToCartForm) {
        addToCartForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productId = this.dataset.productId;
            const quantity = document.getElementById('quantity').value;
            const dimensionId = dimensionInput ? dimensionInput.value : '';
            const patternId = patternInput ? patternInput.value : '';
            
            // Validate required fields
            if (dimensionSelect && !dimensionId) {
                alert('Molimo izaberite dimenzije.');
                dimensionSelect.focus();
                return;
            }
            if (patternSelect && !patternId) {
                alert('Molimo izaberite dezen.');
                patternSelect.focus();
                return;
            }
            
            const formData = new FormData();
            formData.append('quantity', quantity);
            formData.append('dimension_id', dimensionId);
            formData.append('pattern_id', patternId);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch(`/prodavnica/dodaj-u-korpu/${productId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update cart count in header
                    const cartCountElement = document.querySelector('.cart-count');
                    if (cartCountElement) {
                        cartCountElement.textContent = data.cart_count;
                        if (data.cart_count > 0) {
                            cartCountElement.style.display = 'flex';
                        }
                    } else if (data.cart_count > 0) {
                        // Create cart count if it doesn't exist
                        const cartIcon = document.querySelector('.cart-icon');
                        if (cartIcon) {
                            const countSpan = document.createElement('span');
                            countSpan.className = 'cart-count';
                            countSpan.textContent = data.cart_count;
                            cartIcon.appendChild(countSpan);
                        }
                    }
                    
                    // Show notification
                    showCartNotification(data.message);
                } else {
                    alert(data.message);
                }
                    if (data.cart_count !== undefined) {
                        const cartCountEl = document.querySelector('.cart-count');
                        if (cartCountEl) {
                            cartCountEl.textContent = data.cart_count;
                        }
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showCartNotification('Došlo je do greške. Molimo pokušajte ponovo.', 'error');
            });
        });
    }
    
    // Cart notification function
    function showCartNotification(message, type = 'success') {
        // Remove existing notification if any
        const existing = document.querySelector('.cart-notification');
        if (existing) {
            existing.remove();
        }
        
        // Create notification
        const notification = document.createElement('div');
        notification.className = `cart-notification cart-notification-${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Show notification
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        // Hide and remove after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }
});
</script>
{% endblock %}

